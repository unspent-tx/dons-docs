import { MeshTxBuilderBody } from "@meshsdk/common";
import { MeshTxBuilder } from "@meshsdk/core";
import { CardanoSDKSerializer, Transaction, TxCBOR } from "@meshsdk/core-cst";

describe("Ref script inputs", () => {
  it("Basic ref script inputs should be included in fees", async () => {
    const body: Partial<MeshTxBuilderBody> = {
      inputs: [
        {
          type: "PubKey",
          txIn: {
            txHash:
              "e340ffc9e91f43b9390e25d9946583c2d06b8bb97d5e720196e6121a8b19b211",
            txIndex: 0,
            amount: [{ unit: "lovelace", quantity: "27161620" }],
            address:
              "addr_test1qprgjf3u3tkl0qk9738jlyspg25dukxuzrz2lugmp7uypqzw6yxtdssjk4pxv9j489vv8ekkh03wvet9v2y2tsdl6cjs6dsvxs",
            scriptSize: 6069,
          },
        },
        {
          type: "PubKey",
          txIn: {
            txHash:
              "e340ffc9e91f43b9390e25d9946583c2d06b8bb97d5e720196e6121a8b19b211",
            txIndex: 1,
            amount: [{ unit: "lovelace", quantity: "2710990" }],
            address:
              "addr_test1qprgjf3u3tkl0qk9738jlyspg25dukxuzrz2lugmp7uypqzw6yxtdssjk4pxv9j489vv8ekkh03wvet9v2y2tsdl6cjs6dsvxs",
            scriptSize: 396,
          },
        },
        {
          type: "PubKey",
          txIn: {
            txHash:
              "e340ffc9e91f43b9390e25d9946583c2d06b8bb97d5e720196e6121a8b19b211",
            txIndex: 2,
            amount: [{ unit: "lovelace", quantity: "5831430" }],
            address:
              "addr_test1qprgjf3u3tkl0qk9738jlyspg25dukxuzrz2lugmp7uypqzw6yxtdssjk4pxv9j489vv8ekkh03wvet9v2y2tsdl6cjs6dsvxs",
            scriptSize: 1120,
          },
        },
        {
          type: "PubKey",
          txIn: {
            txHash:
              "e340ffc9e91f43b9390e25d9946583c2d06b8bb97d5e720196e6121a8b19b211",
            txIndex: 3,
            amount: [{ unit: "lovelace", quantity: "584756366" }],
            address:
              "addr_test1qprgjf3u3tkl0qk9738jlyspg25dukxuzrz2lugmp7uypqzw6yxtdssjk4pxv9j489vv8ekkh03wvet9v2y2tsdl6cjs6dsvxs",
            scriptSize: 0,
          },
        },
      ],
      outputs: [
        {
          address:
            "addr_test1qprgjf3u3tkl0qk9738jlyspg25dukxuzrz2lugmp7uypqzw6yxtdssjk4pxv9j489vv8ekkh03wvet9v2y2tsdl6cjs6dsvxs",
          amount: [],
          referenceScript: {
            code: "5917b05917ad010100332229800aba4aba2aba1aba0aab9faab9eaab9dab9cab9a9bac0039bae00248888888888a60022a660089213365787065637420636f6c645f7265665f646174756d3a20436f6c64526566446174756d203d20636f6c645f7265665f6461746100168a99802249ff657870656374205b7265665f696e7075745d203d0a20202020202073656c662e7265666572656e63655f696e707574730a20202020202020207c3e206c6973742e66696c746572280a202020202020202020202020666e28696e7075743a20496e70757429202d3e20426f6f6c207b20696e7075742e6f75747075745f7265666572656e6365203d3d2072656465656d6572207d2c0a20202020202020202020290a20202020202020207c3e206c6973742e66696c746572280a202020202020202020202020666e28696e7075743a20496e70757429202d3e20426f6f6c207b0a20202020202020202020202020206c6973742e616e79280a202020202020ff202020202020202020206e66745f6964732c0a20202020202020202020202020202020666e286e66745f69643a20486173683c426c616b6532625f3235362c20506f6c69637949643e29202d3e20426f6f6c207b0a2020202020202020202020202020202020206c6973742e616e79280a2020202020202020202020202020202020202020706f6c696369657328696e7075742e6f75747075742e76616c7565292c0a2020202020202020202020202020202020202020666e28706f6c6963793a20506f6c696379496429202d3e20426f6f6c207b0a20202020202020202020202020202020202020202020626c616b6532625f32353628706f6c6963792973203d3d206e66745f69640a20202020202020202020202020202020202020207d2c0a202020202020202020202020202020202020290a202020202020202020202020202020207d2c0a2020202020202020202020202020290a2020202020202020202020207d2c0a202020202020202020202900168a998022491972656465656d65723a204f75747075745265666572656e6365001648896600264653001300e00198071807800cdc3a4001300e00248889660026004601c6ea800e264b30010058994c00401a26464b300100180644c966002603000513322598009800980a9baa0028992cc004006265300122232598009807800c4c9660020030038992cc0040060090048024012264b3001302300380340150201bae001408c604000280f0c070dd50024566002600a003159800980e1baa004801c00901d40090192032301a375400722232598009807800c4c9660020030038992cc0040060090048024012264b3001302300380340150201bae001408c604000280f0c070dd50024566002600a00313259800800c00e264b300100180240120090048992cc004c08c00e00d00540806eb80050231810000a03c301c3754009002406480c8c068dd5001c888c966002601e00313259800800c00e264b30010018acc004c08800a2b30013011301d375400313259800800c016264b3001001803401a00d006899912cc00400601113259800800c0260130098992cc004c0a000e01700a40946eb40060128140c0940050231bae0013024002409460440028100c078dd5000c01101b401101f401200900480220463020001407860386ea80122b300130050018acc004c070dd5002400e00480ea00480c9019180d1baa0039112cc004c010c068dd5001c56600260366ea800e005001407100140609111191991192cc004c04cc07cdd500544c96600200301b8992cc004006264b300100180ec4c96600200313259800800c07e264b3001302a0028cc00401633001003899911991192cc004c078c0a8dd5000c660026eb4c0b8c0acdd5000c888c9660026030605c6ea80062900044dd6981918179baa00140b064b30013018302e375400314c0103d87a80008998031bab3032302f37540020048160cc01c00c00a4605e6060606060606060606060600032232330010010032259800800c52845660026006606400314a3133002002303300140b081826e21200048888966002600200b1323259800980e800c4c8cc014dd5980318199baa02523375e6066002004606a60646ea800a2b3001302500189801cc004dd5980618191baa0249bae30353032375400548900401914a0817902f18181baa00130333030375403515980099b880054800226464b3001301d001899198029bab30063033375404a466ebcc0cc004008c0d4c0c8dd50014566002604a0031300398009bab300c30323754049375c606a60646ea800a91100401914a0817902f18181baa001301f3030375403514a0816902d22a6605292019c65787065637420536f6d65286d61696e5f6d696e7465645f7175616e7469747929203d0a202020202020696620646963742e73697a65286d696e7465645f746f6b656e7329203d3d2031207b0a2020202020202020646963742e676574286d696e7465645f746f6b656e732c20746f6b656e5f6e616d65290a2020202020207d20656c7365207b0a20202020202020204e6f6e650a2020202020207d001640a0b3001301332330010010032259800800c52000899b8048008cc008008c0c000502d44cc004008096298103d87a8000409c64b300130123028375400314bd6f7b63044dd5981618149baa0014098660026eacc008c0a0dd500d00c911919800800801912cc0040062980103d87a8000899192cc004cdc8802800c56600266e3c014006266e95200033030302e0024bd7045300103d87a800040ad133004004303200340ac6eb8c0b0004c0bc00502d118151815981598159815800911919800800801912cc0040062980103d87a8000899192cc004cdc8802800c56600266e3c014006266e9520003302e302c0024bd7045300103d87a800040a5133004004303000340a46eb8c0a8004c0b400502b4081007408100740810271814000a04c302800280f407a03d01e40a4604c0028120c09800a03901c80e40710271812000a0443020375401501a407444464b300130160018992cc00400600713259800800c01200900480244c9660026054007006802a04e375c0028150c09c00502518119baa0048acc004c030006264b3001001801c4c9660020031598009814801466002003005802202a802204c802401200900440a8604e0028128c08cdd50024566002601c00313259800800c00e264b30010018acc004c0a400a33001001802c01100c4011026401200900480220543027001409460466ea801233001370e90034dc3a4011370e90052444b300130030048992cc00400600d13259800800c01e00f007899912cc00400601313259800800c566002605e00513259800980f800c4c96600200300c8992cc004006264b300100180744c966002003159800981a00146600200719800800c04201e80aa01e80ba01e818a01f00f807c03d0351819000a0603032002806c03601b00d40cc60600028170c0b0dd50014566002602a00313259800800c032264b30010018992cc00400601d13259800800c566002606800519800801c66002003010807a02a807a02e807a062807c03e01f00f40d460640028180c0c800a01b00d806c0350331818000a05c302c3754005159800980b800c4c96600200300c8992cc004006264b300100180744c966002003159800981a00146600200719800800c04201e809a01e80ba01e818a01f00f807c03d0351819000a0603032002806c03601b00d40cc60600028170c0b0dd50014566002601200313259800800c032264b30010018992cc00400601d13259800800c4c9660020030108992cc004006023011808c4c966002606e00719800803466002009013809202c80920348092068375a00301140dc60680028190c0d000a01f00f807c03d0351819000a0603032002806c03601b00d40cc60600028170c0b0dd50014566002601000313259800800c032264b30010018992cc00400601d13259800800c03e01f00f8992cc004c0d400e33001004808c04101840410321bad001807a06a303200140c0606400500d806c03601a8198c0c000502e18161baa0028acc004c01c006264b300100180644c966002003159800981900146600200300e806a02a806a05e806c03601b00d40cc60600028170c0b0dd5001456600266e1d200c0018992cc00400601913259800800c4c96600200300e8992cc00400601f00f807c4c966002606a00719800802404602080c20208190dd6800c03d0351819000a0603032002806c03601b00d40cc60600028170c0b0dd5001456600266e1d200e0018992cc00400601913259800800c03601b00d806c4cc896600200300f8992cc0040060210108084042264b3001303600380940450331bae00140d860660028188dd700098190012066303000140b860586ea800a2b30013370e9008000c4c96600200300c8992cc00400601b00d806c03626644b3001001807c4c9660020030108084042264b3001303600380940450331bad001808206c303300140c46eb8004c0c80090331818000a05c302c375400515980099b8748048006264b300100180644c96600200313259800800c03a264b30010018acc004c0d000a330010038cc00400602100f405d00f405d00f40c500f807c03e01e81a8c0c80050301819001403601b00d806a066303000140b860586ea800a2b30013370e900a000c4c96600200300c8992cc0040062b300130320028cc00400601d00d405500d40bd00d806c03601a8198c0c000502e18161baa002805a05240a48149029205240a48149029205240a48148c0a8dd5000c02902c402a01500a8052060302d00140ac6eb4004c0b000a00e8168c0a800502818131baa0078acc004c008012264b300100180344c966002003159800981600144c966002603800313259800800c026264b30010018acc004c0bc00a33001001805c029012402902c402a01500a8052060302d00140ac60526ea800a2b300130120018992cc00400601313259800800c566002605e00519800800c02e0148092014816201500a80540290301816800a05630293754005159800980a000c4c9660020030098992cc00400601500a805402a264b30013030003806402d02d1bae00140c0605a0028158c0a4dd50014021026204c4098604e6ea800600e814a00f007803c01d02d1815000a0503026375400f159800980080244c9660020030068992cc00400600f007803c4cc89660020030098992cc0040062b3001302f0028acc004c078c0a8dd5000c4c96600200300b8992cc00400601900c80644cc896600200300e8992cc004006264b300100180844c966002003159800981b001466002007132598009813000c4c9660020030138992cc004006264b300100180ac4c966002003016899912cc00400603113259800800c566002607c0051980080344cc07000c896600200519800801c072036812226464b300100180ec07603b1332230053044006375a002607c00501d410c6078002607e00481ea032810203281da03301980cc06503f181e000a0743756002607600501680b405903c181c800a06e303900280a405202901440e8606e00281a8c0ccdd50014566002603800313259800800c04e264b30010018992cc00400602b13259800800c566002607600519800801c5660026054606c6ea8006264b300100180bc4c96600200301880c406226644b300100180d44c96600200301b80dc06e264b3001304100380ec07103e1bad00180da082303e00140f06eb4004c0f400a03081f0c0ec005039181b9baa00180b206880b203a80b207080b405a02d01640f0607200281b8c0e400a02901480a405103a181b800a06a30333754005159800980f000c4c9660020030138992cc0040060291332259800800c05a264b30010018acc004c0f000a26603400644b30010028cc00400e03501940891323259800800c4c96600200301c80e4072265300100389802982100340750251bad00180e2084303c00280dc06e03701b41046074002607a00481da02e81ca02f01780bc05d03d181d000a0703756002607200501480a405103a181b800a06a303337540051598009808000c4c9660020030138992cc0040062b300130390028cc00400602b014406d01440d901480a405202881d0c0dc00503518199baa0028acc004c03c006264b3001001809c4c96600200313259800800c056264b300100180b405a26644b300100180c44c966002003019899912cc00400603713259800800c566002608200519800804c4cc07c018896600200513302100522598008014566002606860806ea8016264b3001001810c4c966002003022811408a26644b300100181244c966002003025812c096264b3001304b003813c0990481bad001812a096304800141186eb4004c11c00a0448240c11400504318209baa005810207c899192cc004006264b3001001811c08e0471329800801c4c014c12401a0488160dd6800c08d0491821801408a045022811209030410013044002410913259800800c6600200313002304400380fa04e80fc07e03f01f411460840048202038811a03881f203901c80e4071042181f800a07a3756002607c00501980cc06503f181e000a0743758002607600501680b2078303900140dc607200501480a405202881d0c0dc00503518199baa0028acc004c038006264b3001001809c4c96600200313259800800c056264b30010018acc004c0ec00a330010038acc004c0a8c0d8dd5000c4c9660020030178992cc0040062b3001303d0028cc004006033018408501840e901880c406203081f0c0ec005039181b9baa00180b206880b203a80b207080b405a02d01640f0607200281b8c0e400a02901480a405103a181b800a06a3033375400515980099b87480300062b3001303337540050138092068809206040c08181030206040c08180c0c4dd5000c04501940450334046023011808a06e303400140c8606800500f807c03e01e81a8c0c80050301bad00130310028062064302f00140b460566ea80060148142014816201500a80540290301816800a056375a002605800500740b460540028140c098dd5003c0150232046408c4080810102018109baa0032223259800980a000c4c9660020030038992cc0040060090048024012264b3001302800380340150251bae00140a0604a0028118c084dd50024566002601400313259800800c00e264b30010018acc004c09c00a33001001802c0110074011024401200900480220503025001408c60426ea80122b3001300c0018992cc00400600713259800800c01200900480244cc89660020030068992cc0040062b3001302a0028cc0040060110074029007409d007803c01e00e8158c0a00050261bae001302700240a0604a0028118c084dd5002400901e203c4078603e6ea800c88c8cc00400400c88cc00c004c008008888c966002602600313259800800c00e264b30010018acc004c09800a33001001802c01100940110234012009004802204e3024001408860406ea80122b300130090018acc004c080dd5002400e004810a2b3001300b0018acc004c080dd5002400e004810a00480e901d203a301e3754006370e90014046023011808a038301930163754005153301449013a65787065637420496e6c696e65446174756d28636f6c645f7265665f6461746129203d207265665f696e7075742e6f75747075742e646174756d0016404c602e6030603060286ea8c00cc050dd50009b874801201a80a8c0580050141919800998009bac30023013375400a466ebcc05cc050dd50008049191980080891980119198008009bab300630173754600c602e6ea8010896600200314bd7044cc068c05cc06c004cc008008c070005019119b8f372800200444646600200200644b30010018a508acc004c00cdd7180d800c528c4cc008008c07000501520322232330010010032259800800c52f5c11332259800980280144cc068008cc01001000626600800800280a8c064004c0680050171180a980b000c0250011112cc004c018c048dd5001c4c9660020030028992cc004006007003801c00e26644b3001001802c4c966002003006803401a264b3001301d003804401d01a1bad001803203a301a00140606eb8004c06400901a180b800a02a301337540070014041008804402201080a8dd7180918079baa0038a99806a492754686973207363726970742073686f756c64206f6e6c79206265207573656420746f206d696e7400164030300e0013009375401f149a2a6600e9211856616c696461746f722072657475726e65642066616c736500136564018261249f582000033fea95f3094def4a3a6c0ebfe613e340bb2fa78f95efa44bac679ae34621ff004c010a49746573745f6e616d650001",
            version: "V3",
          },
        },
        {
          address:
            "addr_test1qprgjf3u3tkl0qk9738jlyspg25dukxuzrz2lugmp7uypqzw6yxtdssjk4pxv9j489vv8ekkh03wvet9v2y2tsdl6cjs6dsvxs",
          amount: [],
          referenceScript: {
            code: "5901875901840101003229800aba2aba1aba0aab9faab9eaab9dab9cab9a9bae00248888888896600264646644b30013370e900118041baa0018994c004c034006601a601c0032259800800c528c566002b3001325980099b8748008c030dd5000c52f5bded8c1137566020601a6ea800500a19198008009bab30103011300d3754602000444b30010018a6103d87a8000899192cc004cdc8806000c56600266e3c030006266e9520003301230100024bd7045300103d87a80004035133004004301400340346eb8c038004c04400500f4528c528201a8998010011808000c52820124034911198008009bac301030113011300d37546020010300937540031533007491275363726970742073686f756c64206f6e6c79206265207573656420666f72207370656e64696e67001640186014002601460160026014002600a6ea802a293454cc00d2411856616c696461746f722072657475726e65642066616c7365001365640084c11e581c712fd0534385c193d484e8f5ce54db320bbf4eddcdabb29381659c230001",
            version: "V3",
          },
        },
        {
          address:
            "addr_test1qprgjf3u3tkl0qk9738jlyspg25dukxuzrz2lugmp7uypqzw6yxtdssjk4pxv9j489vv8ekkh03wvet9v2y2tsdl6cjs6dsvxs",
          amount: [],
          referenceScript: {
            code: "59045b5904580101009800a6011e581c04db7710f3b670f73b98ecd530b34269af8d9f5feac01d5a3a8dfa0600a6011e581c712fd0534385c193d484e8f5ce54db320bbf4eddcdabb29381659c2300a6010a49746573745f6e616d6500a60150d8799fd8799f581c4689263c8aedf782c5f44f2f920142a8de58dc10c4aff11b0fb84080ffd8799fd8799fd8799f581c4ed10cb6c212b5426616553958c3e6d6bbe2e665656288a5c1bfd625ffffffff0048888a6002ae8aae86ae82aae7eaae7aaae76ae72ae6a6eb80166eb80126eb800d22222222222598009919194c004c024dd5000cc03400e601a0049112cc004cdc3a4008007133223233225980099b8748000c044dd50014566002600a646600200264660020026eacc05cc060c060c060c060c060c060c050dd5004912cc004006297adef6c60899912cc004c9660026016602e6ea8006266e3cdd7180d980c1baa0010148a9980b2493665787065637420536372697074287769746864726177616c5f7363726970745f6861736829203d207769746864726177616c2e31737400164054602c00513301900233004004001899802002000a02830180013019001405844b30010018a4001133700900119801001180c000a02a8acc004c014c8cc0040040108966002003148002266e012002330020023018001405513375e602a60246ea8c054c048dd500100c4528201e8a50403d15330104913c65787065637420536f6d6528746f6b656e5f6f757470757429203d206f7574707574735f776974685f746f6b656e73207c3e206c6973742e686561640016403cb30010018a6103d87a800089801198091809800a5eb81011180998081baa0073233001001375860266028602860206ea8014896600200314bd7044cc896600266e2120003259800980398099baa0018a40011375a602e60286ea8005011192cc004c01cc04cdd5000c530103d87a8000899198008009bab30183015375400444b30010018a6103d87a8000899192cc004cdc8809000c56600266e3c0480062601466034603000497ae08a60103d87a80004055133004004301c00340546eb8c058004c064005017202232330010013756602e603060286ea800c896600200314c103d87a8000899192cc004cdc8809000c56600266e3c0480062601266032602e00497ae08a60103d87a80004051133004004301b00340506eb8c054004c06000501644cc054008cc0100100062660080080028080c050004c0540050121b8748008dd2a400115980099b874801800e26464b30013370e900018071baa301230130028a518a99806a481304f6e6c7920526567697374657243726564656e7469616c206365727469666963617465732061726520616c6c6f776564001640306eb4c044004c034dd5002454cc02d241265363726970742073686f756c64206f6e6c79206265207573656420666f72206d696e74696e670016402880506018601a0026018002600e6ea8032293454cc01524011856616c696461746f722072657475726e65642066616c7365001365640101",
            version: "V3",
          },
        },
      ],
      collaterals: [],
      requiredSignatures: [],
      referenceInputs: [
        {
          txHash:
            "e340ffc9e91f43b9390e25d9946583c2d06b8bb97d5e720196e6121a8b19b211",
          txIndex: 0,
          scriptSize: 6069,
        },
        {
          txHash:
            "e340ffc9e91f43b9390e25d9946583c2d06b8bb97d5e720196e6121a8b19b211",
          txIndex: 1,
          scriptSize: 396,
        },
        {
          txHash:
            "e340ffc9e91f43b9390e25d9946583c2d06b8bb97d5e720196e6121a8b19b211",
          txIndex: 2,
          scriptSize: 1120,
        },
      ],
      mints: [],
      changeAddress:
        "addr_test1qprgjf3u3tkl0qk9738jlyspg25dukxuzrz2lugmp7uypqzw6yxtdssjk4pxv9j489vv8ekkh03wvet9v2y2tsdl6cjs6dsvxs",
      metadata: new Map(),
      validityRange: {},
      certificates: [],
      withdrawals: [],
      votes: [],
      signingKey: [],
      chainedTxs: [],
      inputsForEvaluation: {},
      network: "preprod",
      extraInputs: [],
      selectionConfig: {
        threshold: "",
        strategy: "experimental",
        includeTxFees: false,
      },
      expectedNumberKeyWitnesses: 0,
      expectedByronAddressWitnesses: [],
    };

    const txHex = await new MeshTxBuilder().complete(body);
    const cardanoTx = Transaction.fromCbor(TxCBOR(txHex));
    expect(cardanoTx.body().fee()).toBeGreaterThanOrEqual(BigInt("628587"));
  });
});
